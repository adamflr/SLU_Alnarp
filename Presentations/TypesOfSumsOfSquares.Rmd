---
title: "Types of Sums of Squares in R"
output: html_document
---
#Types of SS
In unbalanced factorial designs, there is no clear decompositon of the total sum of square into parts explained by each factor.
Commercial software has introduced a taxonomy of four types of possible decomposition methods.

This piece mainly concerns the difference between type II and type III, as those are the most common choices.
Those types of sums of squares are perhaps best introduced by example.

We create a pseudo-random dataset with two binary factors $A$ and $B$. A third variable $A_B$ is calculated as the indicator of $A=B$ and the response $y$ is created so that there is an effect of factor $B$ but not of factor $A$ or the interaction.

```{r}
  set.seed(8)
.a <- data.frame(A = sample(0:1, 100, T),
                 B = sample(0:1, 100, T))
.a$A_B <- as.numeric(.a$A == .a$B)
.a$y <- .a$B + rnorm(100)
for(i in 1:3) {.a[, i] <- factor(.a[, i])}

head(.a)
```
  
  Next, some different possible models are estimated and the SSE calculated. The anova table with type II sums of squares is calculated using the Anova function in the car package.
  
```{r}
  sum(residuals(lm(y ~ A, .a))^2)
sum(residuals(lm(y ~ B, .a))^2)
sum(residuals(lm(y ~ A + B, .a))^2)
sum(residuals(lm(y ~ A + B + A_B, .a))^2)

library(car)

Anova(lm(y ~ A * B, .a), type = 2)
```

We can now identify the calculation of the sums of squares: $SS_{A}$ is the decrease in $SSE$ when the model with factor A and factor B is compared to the model with only factor B; SS_B is similar; $SS_{A\_B}$ is the decrease in $SSE$ when the full-factorial model is compared to the model with factor A and factor B.

We make a similar calculation demonstrating sums of squares of type III. Note that specific contrasts must be set in order to get correct results from the Anova function.

```{r}
  sum(residuals(lm(y ~ A + A_B, .a))^2)
sum(residuals(lm(y ~ B + A_B, .a))^2)
sum(residuals(lm(y ~ A + B, .a))^2)
sum(residuals(lm(y ~ A + B + A_B, .a))^2)

Anova(lm(y ~ A * B, .a, 
         contrasts = list(A = contr.sum,
                          B = contr.sum)), 
      type = 3)

```

So the SS type III is the decrease in SSE when the interaction model is compared to a model where the factor of interest has been dropped.

These examples generalize to models with more factors with more factor levels.

##The Case for Type III



##The Case for Type II
The main advantage of SS type II must be the greater power for main effects, in comparison to type III.
A simple example in an unbalanced design is given below.
The p-value of the F-test differs greatly between SS type II and SS type III.
In the type III case, the main effect is underestimated because of confounding with the interaction effect.

```{r}
  set.seed(6)
.a <- data.frame(A = c(rep(0, 5), rep(0, 5), 
                       rep(1, 50), rep(1, 50)),
                 B = c(rep(0, 5), rep(1, 5), 
                       rep(0, 50), rep(1, 50)))
.a$y <- .a$B + rnorm(dim(.a)[1], sd = 1)
.a$AB <- .a$A == .a$B + 0
with(.a, table(A,B))
.a$A <- factor(.a$A)
.a$B <- factor(.a$B)

mod <- lm(y ~ A * B, .a, 
          contrasts = list(A = contr.sum, B = contr.sum))

Anova(mod, type = 2)
Anova(mod, type = 3)
```
